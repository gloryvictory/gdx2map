# KODA.md - Контекст проекта gdx2map

## Обзор проекта

**gdx2map** — это современное веб-приложение для отображения и взаимодействия с геоданными, разработанное на TypeScript и React. Приложение использует библиотеку Maplibre GL для создания интерактивных карт с поддержкой различных типов геометрии (точки, линии, полигоны) и обеспечивает богатый набор инструментов для работы с пространственными данными.

### Основное назначение
Приложение предназначено для визуализации и анализа геоданных в рамках проекта `gdx2`, предоставляя пользователям интуитивно понятный интерфейс для:
- Просмотра интерактивных карт с множественными слоями данных
- Анализа атрибутов географических объектов
- Экспорта данных в различных форматах
- Работы с лицензионными участками и месторождениями

## Технологический стек

### Frontend архитектура
- **Основной фреймворк**: React 18.3.1 с TypeScript
- **Сборщик**: Vite 5.4.6 для быстрой разработки и оптимизированной сборки
- **Стилизация**: Tailwind CSS 3.4.10 с поддержкой темной/светлой темы
- **UI компоненты**: Radix UI для доступных и настраиваемых компонентов
- **Иконки**: Lucide React для современных векторных иконок

### Картографические технологии
- **Картографическая библиотека**: Maplibre GL 3.6.1 (open-source форк Mapbox GL)
- **React интеграция**: react-map-gl 7.1.7 для удобной работы с React
- **Геообработка**: 
  - Turf.js 7.2.0 для пространственных операций
  - Proj4 2.19.10 для преобразования координатных систем

### Работа с данными
- **HTTP клиент**: Axios 1.12.2 для запросов к API
- **Таблицы**: AG-Grid React 34.2.0 для мощных таблиц с фильтрацией
- **Экспорт**: XLSX 0.18.5 для генерации Excel файлов
- **Утилиты**: class-variance-authority, clsx, tailwind-merge для управления классами

### Инструменты разработки
- **Линтинг и форматирование**: Biome 2.2.4
- **Тестирование**: Vitest для быстрых тестов
- **Конфигурация**: TypeScript 5.6.2 с строгой типизацией

## Архитектура проекта

### Структура директорий
```
src/
├── components/           # React компоненты
│   ├── map/             # Компоненты карты
│   │   └── FeatureTable.tsx
│   ├── ui/              # Базовые UI компоненты
│   │   ├── button.tsx, dialog.tsx, tabs.tsx и др.
│   │   ├── AttributesButton.tsx, LayersButton.tsx
│   │   ├── LegendButton.tsx, SettingsButton.tsx
│   │   └── ReportCardDialog.tsx
│   ├── AppHeader.tsx    # Шапка приложения
│   ├── AttributesPanel.tsx  # Панель атрибутов
│   ├── BottomPanel.tsx      # Нижняя панель
│   ├── LeftPanel.tsx        # Левая панель с инструментами
│   ├── LegendPanel.tsx      # Панель легенды
│   ├── LuMarkerPanel.tsx    # Панель маркеров ЛУ
│   ├── LuSelectPanel.tsx    # Панель выбора ЛУ
│   ├── Map.tsx              # Основной компонент карты
│   └── RightPanel.tsx       # Правая панель
├── constants/            # Константы приложения
│   └── mapStyles.ts     # Стили карт и базовые карты
├── data/                # Данные и конфигурации
│   ├── layers.json      # Конфигурация слоев
│   ├── services.json    # Конфигурация сервисов базовых карт
│   └── services_bad.json
├── layers/              # Конфигурации слоев карты
│   ├── field.ts         # Слой месторождений
│   ├── index.ts         # Главный файл конфигурации
│   ├── lu.ts            # Слой лицензионных участков
│   ├── sta.ts           # Слой полигонов
│   ├── stl.ts           # Слой линий
│   └── stp.ts           # Слой точек
├── lib/                 # Вспомогательные библиотеки
│   ├── basemaps.ts      # Управление базовыми картами
│   ├── excelExport.ts   # Экспорт в Excel
│   └── utils.ts         # Общие утилиты
├── App.tsx              # Главный компонент приложения
├── config.ts            # Конфигурация серверов и API
├── index.css            # Глобальные стили
├── layers.ts            # Типы слоев
├── main.tsx             # Точка входа приложения
└── types.ts             # TypeScript типы
```

### Ключевые компоненты

#### App.tsx - Главный компонент
Центральный компонент, управляющий состоянием всего приложения:
- Управление видимостью панелей и слоев
- Обработка выбора объектов на карте
- Координация между компонентами карты и панелями
- Управление фильтрацией и экспортом данных

#### Map.tsx - Компонент карты
Основной компонент для отображения интерактивной карты:
- Интеграция с Maplibre GL
- Обработка наведения и кликов по объектам
- Управление слоями и их видимостью
- Выделение и подсветка объектов
- Поддержка инструментов выбора (прямоугольник, маркеры)

#### Панели интерфейса
- **LeftPanel**: Навигация и переключение режимов
- **RightPanel**: Основная рабочая область с картой
- **AttributesPanel**: Таблицы атрибутов с фильтрацией и экспортом
- **BottomPanel**: Информация о координатах и зуме

## Конфигурация и настройки

### Серверы и API
```typescript
// src/config.ts
export const TILE_SERVER_URL = 'http://r48-vgeohub01.zsniigg.local:7800';
export const BACKEND_SERVER_URL = 'http://r48-vgeohub01.zsniigg.local:8001';
export const RGF_URL = '/api/v1/report/rgf/';
```

### Основные слои данных
1. **field** - Месторождения (полигоны)
2. **sta** - Отчеты - Полигоны
3. **lu** - Лицензионные участки (полигоны)
4. **stl** - Отчеты - Линии
5. **stp** - Отчеты - Точки

### Поддерживаемые базовые карты
- OpenStreetMap (по умолчанию)
- 2GIS
- Bing (карты, спутник, гибрид)
- Яндекс.Карты (карты, спутник, схемы)
- Digimap
- Waze

## Сборка и запуск

### Основные команды
```bash
# Установка зависимостей
npm install

# Запуск в режиме разработки
npm run dev

# Сборка для production
npm run build

# Предварительный просмотр собранного приложения
npm run preview

# Проверка кода линтером
npm run lint

# Проверка типов TypeScript
npm run typecheck

# Запуск тестов
npm run test

# Запуск тестов в режиме наблюдения
npm run test:watch
```

### Скрипты сборки
- **dev**: Запуск Vite dev сервера
- **build**: Полная сборка с очисткой, TypeScript компиляцией и созданием архива
- **rimraf**: Очистка директорий dist и build
- **zip**: Создание архива собранного приложения
- **lint**: Проверка и автоисправление кода с помощью Biome

### Конфигурация Vite
```typescript
// vite.config.ts
export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
  server: {
    proxy: {
      '/gdx2': {
        target: 'http://r48-vgeohub01.zsniigg.local:7800',
        changeOrigin: true,
        secure: false,
      },
    },
  },
})
```

## Функциональные возможности

### Работа с картой
- **Интерактивное масштабирование и панорамирование**
- **Поддержка множественных слоев с контролем видимости**
- **Выделение объектов при наведении и клике**
- **Зум к выбранным объектам с автоматическим расчетом границ**

### Инструменты выбора
- **Info Mode**: Информация об объектах под курсором
- **Marker Attributes**: Размещение маркеров для получения информации
- **Rectangle Selection**: Выбор объектов прямоугольной областью
- **LU Select**: Специальный инструмент для работы с лицензионными участками

### Атрибутивные данные
- **Таблицы атрибутов** с поддержкой фильтрации и сортировки
- **Экспорт данных в Excel** с русскими названиями столбцов
- **Контекстные меню** для быстрых операций
- **Выделение объектов** из таблицы с автоматическим зумом

### Экспорт и отчетность
- **Экспорт таблиц атрибутов** в формате .xlsx
- **Экспорт данных по лицензионным участкам**
- **Генерация отчетных карточек** с подробной информацией

### Пользовательский интерфейс
- **Адаптивный дизайн** с поддержкой темной/светлой темы
- **Панельный интерфейс** с изменяемыми размерами панелей
- **Индикаторы загрузки** во время обновления карты
- **Всплывающие подсказки** и диалоговые окна

## Правила разработки

### Стиль кода
- **TypeScript**: Строгая типизация с использованием интерфейсов
- **React**: Функциональные компоненты с хуками
- **Именование**: camelCase для переменных и функций, PascalCase для компонентов
- **Импорты**: Абсолютные импорты через alias '@' для src

### Архитектурные принципы
- **Компонентный подход**: Разделение логики на переиспользуемые компоненты
- **Управление состоянием**: Локальное состояние React с useState/useEffect
- **Типобезопасность**: Подробные TypeScript интерфейсы для всех структур данных
- **Производительность**: Использование useMemo для вычисляемых значений

### Обработка ошибок
- **Graceful degradation**: Приложение продолжает работать при сбоях загрузки данных
- **Логирование**: Подробные сообщения об ошибках в консоли
- **Fallback состояния**: Показ индикаторов загрузки и сообщений об ошибках

### Тестирование
- **Vitest**: Быстрые unit тесты
- **Покрытие**: Тестирование критически важных функций
- **Mock данные**: Использование тестовых данных для изоляции компонентов

## Развертывание и эксплуатация

### Требования к системе
- Node.js 18+ для разработки
- Современный браузер с поддержкой WebGL
- Доступ к серверам данных (настроено в config.ts)

### Переменные окружения
Основные URL настроены в `src/config.ts`:
- TILE_SERVER_URL: Сервер тайлов для картографических данных
- BACKEND_SERVER_URL: Основной backend API
- RGF_URL: API для генерации отчетов

### Мониторинг
- Состояние загрузки карты отображается в BottomPanel
- Ошибки записи в консоль браузера
- Индикаторы прогресса для длительных операций

## Лицензия и авторство

**Лицензия**: MIT License  
**Автор**: Vyacheslav Zamaraev  
**Проект**: gdx2map - Map (Maplibre GL) for gdx2 project

---

*Данный документ создан автоматически на основе анализа структуры проекта и содержимого ключевых файлов. Для получения актуальной информации обращайтесь к исходному коду и документации проекта.*